<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Oklab Quantization Demo</title>
  <style>
    body {
      margin: 20px; /* margin around the whole page */
      background: #111;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 40px); /* account for margin */
      overflow: hidden; /* no scrolling */
      box-sizing: border-box;
    }

    .top-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      justify-content: center;
    }

    button, input, select {
      padding: 4px 8px;
      font-size: 0.9em;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    input[type="number"] {
      width: 65px;
      text-align: center;
    }

    .panel {
      margin: 0 auto;
      padding: 10px 15px;
      background: #222;
      border-radius: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px 20px;
      max-width: 900px;
      width: 100%;
      font-size: 0.85em;
      margin-bottom: 50px;
    }

    .panel label {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .swatches {
      flex: 1; /* take remaining space */
      display: flex;
      gap: 20px;
      align-items: center;
      justify-content: center;
      width: 100%;
      min-height: 0; /* prevent overflow */
    }

    .swatch-container {
      flex: 1;
      max-width: 40%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .swatch {
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 15px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
    }

    .hex-label {
      font-family: monospace;
      font-size: 0.9em;
      color: #ccc;
    }

    .error {
      /* background-color: #222; */
      font-size: 1em;
      text-align: center;
      flex-shrink: 0; /* never shrink away */
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <button id="randomize">ðŸŽ² Randomize Color</button>
    <button id="batchTest">ðŸ“Š Batch Test</button>
  </div>

  <div class="panel">
    <label>Preset
      <select id="preset">
        <option value="srgb">sRGB</option>
        <option value="p3">Display-P3</option>
        <option value="hdr">HDR (10k nits)</option>
      </select>
    </label>
    <label>L bits
      <input id="bitsL" type="number" min="1" max="16" value="8">
    </label>
    <label>a bits
      <input id="bitsA" type="number" min="1" max="16" value="8">
    </label>
    <label>b bits
      <input id="bitsB" type="number" min="1" max="16" value="8">
    </label>
    <label>
      <input id="lockTotal" type="checkbox"> Lock total bits
    </label>
    <label>Total bits
      <input id="totalBits" type="number" min="8" max="48" value="24">
    </label>
    <label>L max
      <input id="Lmax" type="number" min="0.5" max="10" step="0.1" value="1.0">
    </label>
    <label>a range (Â±)
      <input id="Arange" type="number" min="0.1" max="1" step="0.01" value="0.25">
    </label>
    <label>b range (Â±)
      <input id="Brange" type="number" min="0.1" max="1" step="0.01" value="0.31">
    </label>
  </div>

  <div class="swatches">
    <div class="swatch-container">
      <div id="original" class="swatch"></div>
      <div id="hexOriginal" class="hex-label">#------</div>
    </div>
    <div class="swatch-container">
      <div id="quantized" class="swatch"></div>
      <div id="hexQuantized" class="hex-label">#------</div>
    </div>
  </div>

  <div id="error" class="error"></div>

  <script type="module">
    import Color from "https://cdn.jsdelivr.net/npm/colorjs.io/dist/color.js";

    function encodeOklab(L, a, b, bitsL, bitsA, bitsB, Lmax, Arange, Brange) {
      const maxL = (1 << bitsL) - 1;
      const maxA = (1 << bitsA) - 1;
      const maxB = (1 << bitsB) - 1;
      const Lbits = Math.round((L / Lmax) * maxL);
      const abits = Math.round(((a + Arange) / (2 * Arange)) * maxA);
      const bbits = Math.round(((b + Brange) / (2 * Brange)) * maxB);
      return (Lbits << (bitsA + bitsB)) | (abits << bitsB) | bbits;
    }

    function decodeOklab(packed, bitsL, bitsA, bitsB, Lmax, Arange, Brange) {
      const maxL = (1 << bitsL) - 1;
      const maxA = (1 << bitsA) - 1;
      const maxB = (1 << bitsB) - 1;
      const bbits = packed & maxB;
      const abits = (packed >> bitsB) & maxA;
      const Lbits = (packed >> (bitsA + bitsB)) & maxL;
      return {
        L: (Lbits / maxL) * Lmax,
        a: (abits / maxA) * (2 * Arange) - Arange,
        b: (bbits / maxB) * (2 * Brange) - Brange
      };
    }

    function randomOklab(Lmax, Arange, Brange) {
      return {
        L: Math.random() * Lmax,
        a: (Math.random() * 2 - 1) * Arange,
        b: (Math.random() * 2 - 1) * Brange
      };
    }

    let currentColor = randomOklab(1.0, 0.25, 0.31);

    function updateColors() {
      const bitsL = parseInt(document.getElementById("bitsL").value, 10);
      const bitsA = parseInt(document.getElementById("bitsA").value, 10);
      const bitsB = parseInt(document.getElementById("bitsB").value, 10);
      const Lmax = parseFloat(document.getElementById("Lmax").value);
      const Arange = parseFloat(document.getElementById("Arange").value);
      const Brange = parseFloat(document.getElementById("Brange").value);

      const orig = currentColor;
      const packed = encodeOklab(orig.L, orig.a, orig.b, bitsL, bitsA, bitsB, Lmax, Arange, Brange);
      const quant = decodeOklab(packed, bitsL, bitsA, bitsB, Lmax, Arange, Brange);

      function oklabToCss(L, a, b) {
        const c = new Color("oklab", [L, a, b]).to("p3", { inGamut: true });
        const [r, g, bl] = c.coords.map(v => Math.min(Math.max(v, 0), 1));
        return `color(display-p3 ${r} ${g} ${bl})`;
      }

      document.getElementById("original").style.background = oklabToCss(orig.L, orig.a, orig.b);
      document.getElementById("quantized").style.background = oklabToCss(quant.L, quant.a, quant.b);

      const origColor = new Color("oklab", [orig.L, orig.a, orig.b]);
      const quantColor = new Color("oklab", [quant.L, quant.a, quant.b]);
      const deltaE = origColor.deltaE(quantColor, { method: "2000" });
      document.getElementById("error").textContent = `Î”E00 (Oklab) = ${deltaE.toFixed(4)}`;

      const origHex = origColor.to("srgb", { inGamut: true }).toString({ format: "hex" });
      const quantHex = quantColor.to("srgb", { inGamut: true }).toString({ format: "hex" });
      document.getElementById("hexOriginal").textContent = origHex;
      document.getElementById("hexQuantized").textContent = quantHex;
    }

    function enforceTotalBits(changed) {
      const lock = document.getElementById("lockTotal").checked;
      if (!lock) return;
      const total = parseInt(document.getElementById("totalBits").value, 10);
      let bitsL = parseInt(document.getElementById("bitsL").value, 10);
      let bitsA = parseInt(document.getElementById("bitsA").value, 10);
      let bitsB = parseInt(document.getElementById("bitsB").value, 10);
      const currentTotal = bitsL + bitsA + bitsB;
      if (currentTotal === total) return;
      if (changed === "L") {
        const remaining = total - bitsL;
        const ratio = bitsA / (bitsA + bitsB || 1);
        bitsA = Math.max(1, Math.round(remaining * ratio));
        bitsB = Math.max(1, remaining - bitsA);
      } else {
        const remaining = total - (bitsA + bitsB);
        bitsL = Math.max(1, remaining);
      }
      document.getElementById("bitsL").value = bitsL;
      document.getElementById("bitsA").value = bitsA;
      document.getElementById("bitsB").value = bitsB;
    }

    function applyPreset(preset) {
      if (preset === "srgb") {
        document.getElementById("Lmax").value = 1.0;
        document.getElementById("Arange").value = 0.25;
        document.getElementById("Brange").value = 0.31;
        document.getElementById("bitsL").value = 8;
        document.getElementById("bitsA").value = 8;
        document.getElementById("bitsB").value = 8;
        document.getElementById("totalBits").value = 24;
      } else if (preset === "p3") {
        document.getElementById("Lmax").value = 1.0;
        document.getElementById("Arange").value = 0.4;
        document.getElementById("Brange").value = 0.4;
        document.getElementById("bitsL").value = 10;
        document.getElementById("bitsA").value = 8;
        document.getElementById("bitsB").value = 8;
        document.getElementById("totalBits").value = 26;
      } else if (preset === "hdr") {
        document.getElementById("Lmax").value = 2.0;
        document.getElementById("Arange").value = 0.5;
        document.getElementById("Brange").value = 0.5;
        document.getElementById("bitsL").value = 12;
        document.getElementById("bitsA").value = 10;
        document.getElementById("bitsB").value = 10;
        document.getElementById("totalBits").value = 32;
      }
      updateColors();
    }

    function batchTest(Lstep = 0.01, astep = 0.01, bstep = 0.01) {
      const bitsL = parseInt(document.getElementById("bitsL").value, 10);
      const bitsA = parseInt(document.getElementById("bitsA").value, 10);
      const bitsB = parseInt(document.getElementById("bitsB").value, 10);
      const Lmax = parseFloat(document.getElementById("Lmax").value);
      const Arange = parseFloat(document.getElementById("Arange").value);
      const Brange = parseFloat(document.getElementById("Brange").value);

      let total = 0, min = Infinity, max = -Infinity;
      let samples = 0;
      
      for ( let L = 0; L < Lmax; L += Lstep ) {
      for ( let a = -Arange; a < Arange; a += astep ) {
      for ( let b = -Brange; b < Brange; b += bstep ) {
        const c = { L, a, b };
        const packed = encodeOklab(c.L, c.a, c.b, bitsL, bitsA, bitsB, Lmax, Arange, Brange);
        const q = decodeOklab(packed, bitsL, bitsA, bitsB, Lmax, Arange, Brange);
        const origColor = new Color("oklab", [c.L, c.a, c.b]);
        const quantColor = new Color("oklab", [q.L, q.a, q.b]);
        const dE = origColor.deltaE(quantColor, { method: "2000" });
        total += dE;
        if (dE < min) min = dE;
        if (dE > max) max = dE;
        samples++;
      }}}
      
      const avg = total / samples;
      document.getElementById("error").textContent =
        `Î”E00 avg=${avg.toFixed(4)} min=${min.toFixed(4)} max=${max.toFixed(4)} (n=${samples})`;
    }

    document.getElementById("randomize").addEventListener("click", () => {
      const Lmax = parseFloat(document.getElementById("Lmax").value);
      const Arange = parseFloat(document.getElementById("Arange").value);
      const Brange = parseFloat(document.getElementById("Brange").value);
      currentColor = randomOklab(Lmax, Arange, Brange);
      updateColors();
    });
    document.getElementById("batchTest").addEventListener("click", () => batchTest(100_000));
    document.getElementById("bitsL").addEventListener("input", () => { enforceTotalBits("L"); updateColors(); });
    document.getElementById("bitsA").addEventListener("input", () => { enforceTotalBits("A"); updateColors(); });
    document.getElementById("bitsB").addEventListener("input", () => { enforceTotalBits("B"); updateColors(); });
    document.getElementById("lockTotal").addEventListener("change", () => { enforceTotalBits(); updateColors(); });
    document.getElementById("totalBits").addEventListener("input", () => { enforceTotalBits(); updateColors(); });
    document.getElementById("Lmax").addEventListener("input", updateColors);
    document.getElementById("Arange").addEventListener("input", updateColors);
    document.getElementById("Brange").addEventListener("input", updateColors);
    document.getElementById("preset").addEventListener("change", e => applyPreset(e.target.value));

    updateColors();
  </script>
</body>
</html>